<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>MonBibiTime - Suivi biberons & changes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg: #0f172a;
            --bg-card: #020617;
            --accent: #38bdf8;
            --accent-soft: rgba(56, 189, 248, 0.15);
            --text: #e5e7eb;
            --muted: #9ca3af;
            --danger: #f97373;
            --radius: 18px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #1d283a 0, #020617 55%, #020617 100%);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            width: 100%;
            max-width: 1100px;
            padding: 1.8rem 1.5rem 0.5rem;
        }

        h1 {
            margin: 0;
            font-size: clamp(1.5rem, 3vw, 2rem);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: .6rem;
        }

        h1 span.icon {
            font-size: 1.6rem;
        }

        .subtitle {
            margin-top: .3rem;
            font-size: .9rem;
            color: var(--muted);
        }

        main {
            width: 100%;
            max-width: 1100px;
            padding: 0 1.5rem 2rem;
        }

        .date-bar {
            margin: 1rem 0 1.5rem;
            display: flex;
            align-items: center;
            gap: .75rem;
            flex-wrap: wrap;
        }

        .date-bar label {
            font-size: .9rem;
            color: var(--muted);
        }

        .date-bar input[type="date"] {
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(148, 163, 184, 0.35);
            color: var(--text);
            padding: .4rem .7rem;
            border-radius: 999px;
            font-size: .9rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1.2rem;
        }

        @media (max-width: 800px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.9));
            border-radius: var(--radius);
            border: 1px solid rgba(148, 163, 184, 0.18);
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.8);
            padding: 1.2rem;
            backdrop-filter: blur(16px);
        }

        .card h2 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: .4rem;
        }

        .card h2 span {
            font-size: 1.2rem;
        }

        .card small {
            display: block;
            margin-top: .2rem;
            font-size: .8rem;
            color: var(--muted);
        }

        form {
            margin-top: .8rem;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: .6rem .8rem;
            align-items: end;
        }

        form .field {
            display: flex;
            flex-direction: column;
            gap: .2rem;
            font-size: .8rem;
        }

        label {
            color: var(--muted);
        }

        input[type="time"],
        input[type="number"] {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.4);
            border-radius: 999px;
            padding: .4rem .7rem;
            color: var(--text);
            font-size: .9rem;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
             -moz-appearance: textfield;
        }

        .checkbox-row {
            display: flex;
            gap: .7rem;
            align-items: center;
            font-size: .85rem;
        }

        .checkbox-row label {
            display: flex;
            align-items: center;
            gap: .25rem;
            cursor: pointer;
        }

        .checkbox-row input[type="checkbox"] {
            accent-color: var(--accent);
        }

        button[type="submit"] {
            grid-column: 1 / -1;
            margin-top: .1rem;
            border: none;
            border-radius: 999px;
            padding: .45rem .9rem;
            font-size: .9rem;
            cursor: pointer;
            background: radial-gradient(circle at top left, var(--accent), #0ea5e9);
            color: #0b1120;
            font-weight: 600;
            box-shadow: 0 10px 25px rgba(56, 189, 248, 0.4);
            transition: transform .1s ease, box-shadow .1s ease, translate .1s ease;
        }

        button[type="submit"]:hover {
            transform: translateY(-1px);
            box-shadow: 0 14px 30px rgba(56, 189, 248, 0.55);
        }

        button[type="submit"]:active {
            transform: translateY(0);
            box-shadow: 0 6px 15px rgba(56, 189, 248, 0.35);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: .85rem;
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.98));
            border-radius: 12px;
            overflow: hidden;
        }

        thead {
            background: rgba(15, 23, 42, 0.96);
        }

        th, td {
            padding: .45rem .55rem;
            text-align: left;
        }

        th {
            font-weight: 500;
            font-size: .8rem;
            color: var(--muted);
            border-bottom: 1px solid rgba(148, 163, 184, 0.3);
        }

        tbody tr:nth-child(even) {
            background: rgba(15, 23, 42, 0.9);
        }

        tbody tr:nth-child(odd) {
            background: rgba(15, 23, 42, 0.75);
        }

        tbody tr:hover {
            background: rgba(56, 189, 248, 0.12);
        }

        .empty-row td {
            text-align: center;
            color: var(--muted);
            font-style: italic;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: .2rem;
            padding: .15rem .4rem;
            border-radius: 999px;
            font-size: .75rem;
            background: var(--accent-soft);
            color: var(--accent);
        }

        /* Bouton X de suppression */
        .btn-x {
            border: none;
            border-radius: 999px;
            padding: 0.1rem 0.45rem;
            font-size: 0.8rem;
            cursor: pointer;
            background: rgba(248, 113, 113, 0.12);
            color: #fecaca;
            transition: background .15s ease, transform .1s ease;
        }

        .btn-x:hover {
            background: rgba(248, 113, 113, 0.28);
            transform: translateY(-1px);
        }

        .btn-x:active {
            transform: translateY(0);
        }

        /* R√©capitulatif */
        .recap-card {
            margin-top: 1.5rem;
        }

        .recap-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .recap-content {
            margin-top: .8rem;
            font-size: .85rem;
        }

        .recap-list {
            margin: .2rem 0 .8rem 1.1rem;
            padding: 0;
            list-style: disc;
        }

        .recap-muted {
            color: var(--muted);
            font-style: italic;
        }

        .btn-secondary {
            border-radius: 999px;
            padding: .4rem .9rem;
            border: 1px solid rgba(148, 163, 184, 0.6);
            background: rgba(15, 23, 42, 0.9);
            color: var(--text);
            font-size: .85rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: .35rem;
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.9);
        }

        .bibitime-stats-root {
    --accent: #38bdf8;
    --accent-soft: #FFFFFF;
    --text: #111827;
    --muted: #FFFFFF;
    --radius: 18px;

    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;

    /* üìå Nouvelle m√©thode ‚Üí Full width propre */
    width: 100%;
    max-width: none !important;      /* on supprime la limite du th√®me */
    padding-left: 0;
    padding-right: 0;

    /* üìå Centre + limite interne */
    display: flex;
    justify-content: center;
}
.bibitime-stats-root {
    position: relative;
    left: 50%;
    width: 100vw;
    margin-left: -50vw;
    display: flex;
    justify-content: center;
}


.bibitime-stats-card {
    width: 100%;
    max-width: 1100px;               /* üëâ largeur identique √† bibitime */
    margin: 2rem 1rem;
}


.bibitime-stats-chart-wrapper canvas {
    width: 100%;         /* ‚úî responsive */
    max-width: 1100px;   /* ‚úî align√© avec bibitime */
    max-height: 360px;
}
/* üì± Sur mobile : graphique plus grand, plus lisible */
@media (max-width: 768px) {
  .bibitime-stats-chart-wrapper canvas {
    max-height: 550px !important;
  }

  .bibitime-stats-card {
    padding: 1rem 1rem 1.5rem;
  }

  .bibitime-stats-header h2 {
    font-size: 1.25rem;
  }
}


    .bibitime-stats-card {
        padding: 1rem 1rem 1.5rem;      /* un peu plus compact */
    }

    .bibitime-stats-header h2 {
        font-size: 1.25rem;             /* titre un peu plus gros */
    }


        .bibitime-stats-root.bibitime-stats-dark {
    --bg-card: #020617;  /* ou la couleur que tu veux */
    color: #f9fafb;
     border: 1px solid rgba(255, 255, 255, 0.35);
       border-radius: var(--radius);

}
.bibitime-stats-card {
    background: var(--bg-card);
}

        .bibitime-stats-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow: 0 14px 30px rgba(15, 23, 42, 0.12);
            padding: 1.4rem 1.5rem 1.6rem;
            
        }
        .bibitime-stats-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        .bibitime-stats-header h2 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: .4rem;
        }
        .bibitime-stats-header h2 span { font-size: 1.2rem; }
        .bibitime-stats-header small {
            display: block;
            margin-top: .15rem;
            font-size: .8rem;
            color: var(--muted);
        }
        .bibitime-stats-filters {
            display: flex;
            flex-direction: column;
            gap: .35rem;
            min-width: 220px;
        }
        .bibitime-stats-filters label {
            font-size: .8rem;
            color: var(--muted);
            display: flex;
            align-items: center;
            gap: .35rem;
        }
        .bibitime-stats-filters select {
            width: 100%;
            min-height: 3.5rem;
            border-radius: 12px;
            border: 1px solid rgba(148,163,184,0.7);
            font-size: .85rem;
            padding: .35rem .5rem;
        }
        .bibitime-stats-tag {
            display: inline-flex;
            align-items: center;
            gap: .3rem;
            padding: .2rem .5rem;
            border-radius: 999px;
            font-size: .75rem;
            background: var(--accent-soft);
            color: var(--accent);
            margin-top: .3rem;
        }
        .bibitime-stats-info {
            margin-top: .5rem;
            font-size: .8rem;
            color: var(--muted);
        }
        .bibitime-stats-chart-wrapper {
            margin-top: 1rem;
        }

.bibitime-stats-chart-wrapper canvas {
    width: 100%;         /* ‚úî responsive */
    max-width: 1100px;   /* ‚úî align√© avec bibitime */
    max-height: 360px;
}

 .card2 {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.9));
            border-radius: var(--radius);
            border: 1px solid rgba(148, 163, 184, 0.18);
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.8);
            padding: 1.2rem;
            backdrop-filter: blur(16px);
        }
    </style>
</head>
<body>
<header>
    <h1><span class="icon">üçº</span> MonBibiTime</h1>
        <div class="subtitle">
            Suivi quotidien des biberons et des changes de b√©b√©.
        </div>

</header>

<main>
    <!-- Choix de la date -->
    <div class="date-bar">
        <label for="dateJour">Date du suivi :</label>
        <input type="date" id="dateJour">
        <span class="tag">Donn√©es sauvegard√©es automatiquement par jour</span>
    </div>

    <div class="grid">
        <!-- Biberons -->
        <section class="card">
            <h2><span>üçº</span> Biberons</h2>
            <small>Ajoute l‚Äôheure de la prise et la quantit√© bue.</small>

            <form id="formBiberon">
                <div class="field">
                    <label for="heureBiberon">Heure du biberon</label>
                    <input type="time" id="heureBiberon" required>
                </div>
                <div class="field">
                    <label for="quantiteBiberon">Quantit√© (ml)</label>
                    <!-- PATCH : step="1" pour pouvoir mettre 55, 61, 65, etc. -->
                    <input type="number" id="quantiteBiberon" min="0" step="1" required>
                </div>
                <button type="submit">Ajouter le biberon</button>
            </form>

            <table>
                <thead>
                <tr>
                    <th>Heure</th>
                    <th>Quantit√©</th>
                    <th></th> <!-- colonne X -->
                </tr>
                </thead>
                <tbody id="tableBiberonsBody">
                <!-- Lignes ajout√©es en JS -->
                </tbody>
            </table>
        </section>

        <!-- Changes -->
        <section class="card">
            <h2><span>üß∑</span> Changes</h2>
            <small>Note si c‚Äôest urine, selles (ou les deux) avec l‚Äôheure du change.</small>

            <form id="formChange">
                <div class="field">
                    <label for="heureChange">Heure du change</label>
                    <input type="time" id="heureChange" required>
                </div>
                <div class="field">
                    <label>Type de change</label>
                    <div class="checkbox-row">
                        <label>
                            <input type="checkbox" id="changeUrine">
                            Urine
                        </label>
                        <label>
                            <input type="checkbox" id="changeSelles">
                            Selles
                        </label>
                    </div>
                </div>
                <button type="submit">Ajouter le change</button>
            </form>

            <table>
                <thead>
                <tr>
                    <th>Heure</th>
                    <th>Urine</th>
                    <th>Selles</th>
                    <th></th> <!-- colonne X -->
                </tr>
                </thead>
                <tbody id="tableChangesBody">
                <!-- Lignes ajout√©es en JS -->
                </tbody>
            </table>
        </section>
         <section class="card">
  <h2><span>üìù</span> Commentaires</h2>
  <small>Ajoute une note (heure + commentaire) pour la journ√©e.</small>

  <form id="formCommentaire">
    <div class="field">
      <label for="heureCommentaire">Heure</label>
      <input type="time" id="heureCommentaire" required>
    </div>

    <div class="field" style="grid-column: 1 / -1;">
      <label for="texteCommentaire">Commentaire</label>
      <textarea id="texteCommentaire" rows="2" placeholder="Ex: prise de m√©dicament, √©tat, fi√®vre, rdv..." required></textarea>
    </div>

    <button type="submit">Ajouter le commentaire</button>
  </form>

  <table>
    <thead>
      <tr>
        <th>Heure</th>
        <th>Commentaire</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="tableCommentairesBody"></tbody>
  </table>
</section>

  
    

    <!-- R√©capitulatif du jour -->
    <section class="card">
        <div class="recap-header">
            <div>
                <h2>üìä R√©capitulatif du jour</h2>
                <small>Vue globale des biberons, des changes et du total bu pour la date s√©lectionn√©e.</small>
            </div>
            <button id="btnExportPdf" type="button" class="btn-secondary">
                üìÑ Exporter en PDF
            </button>
        </div>
        <div id="recapContent" class="recap-content">
            <!-- R√©cap g√©n√©r√© en JS -->
        </div>
    </section>
   
         <div class="bibitime-stats-card">
            <div class="bibitime-stats-header">
                <div>
                    <h2><span>üìà</span> √âvolution des biberons</h2>
                    <small>
                        Compare les <strong>totaux bu (ml)</strong> sur plusieurs jours pour voir la progression ou la r√©gression.
                    </small>
                    <div class="bibitime-stats-tag">S√©lectionne 2 dates ou plus pour une comparaison fine.</div>
                    <div id="bibitimeStatsInfo" class="bibitime-stats-info">
                        Chargement des donn√©es...
                    </div>
                </div>
                <div class="bibitime-stats-filters">
                    <label for="bibitimeStatsDates">
                        Dates disponibles (multi-s√©lection) :
                    </label>
                    <select id="bibitimeStatsDates" multiple></select>
                    <small>
                        Astuce : Ctrl/Cmd + clic pour s√©lectionner plusieurs dates.
                    </small>
                </div>
            </div>

            <div class="bibitime-stats-chart-wrapper">
                <canvas id="bibitimeStatsChart"></canvas>
            </div>
        </div>
   </div>
</main>

<!-- jsPDF pour l'export PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  // ----- DOM -----
  const dateInput = document.getElementById('dateJour');

  const tableBiberonsBody = document.getElementById('tableBiberonsBody');
  const tableChangesBody = document.getElementById('tableChangesBody');
  const tableCommentairesBody = document.getElementById('tableCommentairesBody');

  const formBiberon = document.getElementById('formBiberon');
  const formChange = document.getElementById('formChange');
  const formCommentaire = document.getElementById('formCommentaire');

  const heureBiberonInput = document.getElementById('heureBiberon');
  const quantiteBiberonInput = document.getElementById('quantiteBiberon');

  const heureChangeInput = document.getElementById('heureChange');
  const changeUrineInput = document.getElementById('changeUrine');
  const changeSellesInput = document.getElementById('changeSelles');

  const heureCommentaireInput = document.getElementById('heureCommentaire');
  const texteCommentaireInput = document.getElementById('texteCommentaire');

  const recapContent = document.getElementById('recapContent');
  const btnExportPdf = document.getElementById('btnExportPdf');

  // ----- DATA -----
  let currentData = { biberons: [], changes: [], commentaires: [] };

  function getTodayStr() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  function getCurrentTimeStr() {
    const now = new Date();
    const h = String(now.getHours()).padStart(2, '0');
    const m = String(now.getMinutes()).padStart(2, '0');
    return `${h}:${m}`;
  }

  function formatFrenchDate(dateStr) {
    if (!dateStr) return '-';
    const parts = dateStr.split('-');
    if (parts.length !== 3) return dateStr;
    const [y, m, d] = parts;
    return `${d}/${m}/${y}`;
  }

  function getStorageKey() {
    return 'suivi-bebe-' + dateInput.value;
  }

  function ensureIds() {
    // biberons
    currentData.biberons.forEach((b, idx) => {
      if (!b.id) b.id = 'bib-' + Date.now() + '-' + idx + '-' + Math.random().toString(16).slice(2);
    });

    // changes
    currentData.changes.forEach((c, idx) => {
      if (!c.id) c.id = 'chg-' + Date.now() + '-' + idx + '-' + Math.random().toString(16).slice(2);
    });

    // commentaires
    currentData.commentaires.forEach((c, idx) => {
      if (!c.id) c.id = 'com-' + Date.now() + '-' + idx + '-' + Math.random().toString(16).slice(2);
    });
  }

  function loadForCurrentDate() {
    const saved = localStorage.getItem(getStorageKey());

    if (saved) {
      try {
        currentData = JSON.parse(saved) || {};
      } catch (e) {
        currentData = {};
      }
    } else {
      currentData = {};
    }

    // fallback safe
    if (!Array.isArray(currentData.biberons)) currentData.biberons = [];
    if (!Array.isArray(currentData.changes)) currentData.changes = [];
    if (!Array.isArray(currentData.commentaires)) currentData.commentaires = [];

    ensureIds();
    saveCurrentData(); // upgrade old saved data
    renderTables();
  }

  function saveCurrentData() {
    localStorage.setItem(getStorageKey(), JSON.stringify(currentData));
  }

  function updateRecap() {
    const dateFr = formatFrenchDate(dateInput.value);

    const nbBiberons = currentData.biberons.length;
    const totalMl = currentData.biberons.reduce((sum, b) => sum + (b.quantite || 0), 0);

    const sortedBib = [...currentData.biberons].sort((a, b) => a.heure.localeCompare(b.heure));
    const sortedCh = [...currentData.changes].sort((a, b) => a.heure.localeCompare(b.heure));
    const sortedCom = [...currentData.commentaires].sort((a, b) => a.heure.localeCompare(b.heure));

    let html = '';
    html += `<p><strong>Date :</strong> ${dateFr}</p>`;

    // biberons
    html += `<p><strong>Biberons :</strong> ${nbBiberons} pour un total de <strong>${totalMl} ml</strong></p>`;
    if (!sortedBib.length) {
      html += `<p class="recap-muted">Aucun biberon saisi pour cette date.</p>`;
    } else {
      html += `<ul class="recap-list">`;
      sortedBib.forEach(bib => {
        html += `<li>${bib.heure} ‚Äî ${bib.quantite} ml</li>`;
      });
      html += `</ul>`;
    }

    // changes
    html += `<p><strong>Changes :</strong> ${sortedCh.length}</p>`;
    if (!sortedCh.length) {
      html += `<p class="recap-muted">Aucun change saisi pour cette date.</p>`;
    } else {
      html += `<ul class="recap-list">`;
      sortedCh.forEach(ch => {
        const types = [];
        if (ch.urine) types.push('urine');
        if (ch.selles) types.push('selles');
        html += `<li>${ch.heure} ‚Äî ${types.join(' + ')}</li>`;
      });
      html += `</ul>`;
    }

    // commentaires
    html += `<p><strong>Commentaires :</strong> ${sortedCom.length}</p>`;
    if (!sortedCom.length) {
      html += `<p class="recap-muted">Aucun commentaire pour cette date.</p>`;
    } else {
      html += `<ul class="recap-list">`;
      sortedCom.forEach(c => {
        const safe = (c.texte || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
        html += `<li>${c.heure} ‚Äî ${safe}</li>`;
      });
      html += `</ul>`;
    }

    recapContent.innerHTML = html;
  }

  function renderTables() {
    // ----- BIBERONS -----
    tableBiberonsBody.innerHTML = '';
    if (!currentData.biberons.length) {
      const tr = document.createElement('tr');
      tr.classList.add('empty-row');
      const td = document.createElement('td');
      td.colSpan = 3;
      td.textContent = 'Aucun biberon saisi pour cette date.';
      tr.appendChild(td);
      tableBiberonsBody.appendChild(tr);
    } else {
      const sorted = [...currentData.biberons].sort((a, b) => a.heure.localeCompare(b.heure));
      sorted.forEach(bib => {
        const tr = document.createElement('tr');

        const tdHeure = document.createElement('td');
        const tdQuantite = document.createElement('td');
        const tdX = document.createElement('td');

        tdHeure.textContent = bib.heure;
        tdQuantite.textContent = bib.quantite + ' ml';

        const btn = document.createElement('button');
        btn.textContent = '‚úï';
        btn.className = 'btn-x btn-delete-bib';
        btn.dataset.id = bib.id;
        tdX.appendChild(btn);

        tr.appendChild(tdHeure);
        tr.appendChild(tdQuantite);
        tr.appendChild(tdX);
        tableBiberonsBody.appendChild(tr);
      });
    }

    // ----- CHANGES -----
    tableChangesBody.innerHTML = '';
    if (!currentData.changes.length) {
      const tr = document.createElement('tr');
      tr.classList.add('empty-row');
      const td = document.createElement('td');
      td.colSpan = 4;
      td.textContent = 'Aucun change saisi pour cette date.';
      tr.appendChild(td);
      tableChangesBody.appendChild(tr);
    } else {
      const sortedC = [...currentData.changes].sort((a, b) => a.heure.localeCompare(b.heure));
      sortedC.forEach(ch => {
        const tr = document.createElement('tr');

        const tdHeure = document.createElement('td');
        const tdUrine = document.createElement('td');
        const tdSelles = document.createElement('td');
        const tdX = document.createElement('td');

        tdHeure.textContent = ch.heure;
        tdUrine.textContent = ch.urine ? 'Oui' : '-';
        tdSelles.textContent = ch.selles ? 'Oui' : '-';

        const btn = document.createElement('button');
        btn.textContent = '‚úï';
        btn.className = 'btn-x btn-delete-change';
        btn.dataset.id = ch.id;
        tdX.appendChild(btn);

        tr.appendChild(tdHeure);
        tr.appendChild(tdUrine);
        tr.appendChild(tdSelles);
        tr.appendChild(tdX);
        tableChangesBody.appendChild(tr);
      });
    }

    // ----- COMMENTAIRES -----
    tableCommentairesBody.innerHTML = '';
    if (!currentData.commentaires.length) {
      const tr = document.createElement('tr');
      tr.classList.add('empty-row');
      const td = document.createElement('td');
      td.colSpan = 3;
      td.textContent = 'Aucun commentaire pour cette date.';
      tr.appendChild(td);
      tableCommentairesBody.appendChild(tr);
    } else {
      const sortedCom = [...currentData.commentaires].sort((a, b) => a.heure.localeCompare(b.heure));
      sortedCom.forEach(c => {
        const tr = document.createElement('tr');

        const tdHeure = document.createElement('td');
        const tdTexte = document.createElement('td');
        const tdX = document.createElement('td');

        tdHeure.textContent = c.heure;
        tdTexte.textContent = c.texte;

        const btn = document.createElement('button');
        btn.textContent = '‚úï';
        btn.className = 'btn-x btn-delete-com';
        btn.dataset.id = c.id;
        tdX.appendChild(btn);

        tr.appendChild(tdHeure);
        tr.appendChild(tdTexte);
        tr.appendChild(tdX);

        tableCommentairesBody.appendChild(tr);
      });
    }

    updateRecap();
  }

  function refreshDefaultTimes() {
    const nowStr = getCurrentTimeStr();
    heureBiberonInput.value = nowStr;
    heureChangeInput.value = nowStr;
    heureCommentaireInput.value = nowStr;
  }

  // ----- EVENTS -----
  dateInput.addEventListener('change', () => {
    loadForCurrentDate();
    refreshDefaultTimes();
  });

  // Ajout biberon
  formBiberon.addEventListener('submit', (e) => {
    e.preventDefault();
    const heure = heureBiberonInput.value || getCurrentTimeStr();
    const quantite = parseInt(quantiteBiberonInput.value, 10);

    if (isNaN(quantite)) {
      alert('Merci de saisir une quantit√© valide.');
      return;
    }

    const id = 'bib-' + Date.now() + '-' + Math.random().toString(16).slice(2);
    currentData.biberons.push({ id, heure, quantite });

    saveCurrentData();
    renderTables();

    formBiberon.reset();
    refreshDefaultTimes();
  });

  // Ajout change
  formChange.addEventListener('submit', (e) => {
    e.preventDefault();
    const heure = heureChangeInput.value || getCurrentTimeStr();
    const urine = changeUrineInput.checked;
    const selles = changeSellesInput.checked;

    if (!urine && !selles) {
      alert('Coche au moins Urine ou Selles pour le change.');
      return;
    }

    const id = 'chg-' + Date.now() + '-' + Math.random().toString(16).slice(2);
    currentData.changes.push({ id, heure, urine, selles });

    saveCurrentData();
    renderTables();

    formChange.reset();
    refreshDefaultTimes();
  });

  // Ajout commentaire
  formCommentaire.addEventListener('submit', (e) => {
    e.preventDefault();

    const heure = heureCommentaireInput.value || getCurrentTimeStr();
    const texte = (texteCommentaireInput.value || '').trim();

    if (!texte) {
      alert('Merci de saisir un commentaire.');
      return;
    }

    const id = 'com-' + Date.now() + '-' + Math.random().toString(16).slice(2);
    currentData.commentaires.push({ id, heure, texte });

    saveCurrentData();
    renderTables();

    formCommentaire.reset();
    refreshDefaultTimes();
  });

  // Suppression biberon (delegation)
  tableBiberonsBody.addEventListener('click', (e) => {
    const btn = e.target.closest('.btn-delete-bib');
    if (!btn) return;
    const id = btn.dataset.id;

    currentData.biberons = currentData.biberons.filter(b => b.id !== id);
    saveCurrentData();
    renderTables();
  });

  // Suppression change (delegation)
  tableChangesBody.addEventListener('click', (e) => {
    const btn = e.target.closest('.btn-delete-change');
    if (!btn) return;
    const id = btn.dataset.id;

    currentData.changes = currentData.changes.filter(c => c.id !== id);
    saveCurrentData();
    renderTables();
  });

  // Suppression commentaire (delegation)
  tableCommentairesBody.addEventListener('click', (e) => {
    const btn = e.target.closest('.btn-delete-com');
    if (!btn) return;
    const id = btn.dataset.id;

    currentData.commentaires = currentData.commentaires.filter(c => c.id !== id);
    saveCurrentData();
    renderTables();
  });

  // ----- PDF -----
  function exportPdf() {
    if (!window.jspdf || !window.jspdf.jsPDF) {
      alert('La biblioth√®que jsPDF ne s‚Äôest pas charg√©e correctement.');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    let y = 10;
    const dateFr = formatFrenchDate(dateInput.value);
    const totalMl = currentData.biberons.reduce((sum, b) => sum + (b.quantite || 0), 0);

    doc.setFontSize(14);
    doc.text(`Suivi b√©b√© - ${dateFr}`, 10, y);
    y += 8;

    // Biberons
    doc.setFontSize(12);
    doc.text(`Biberons (${currentData.biberons.length})`, 10, y);
    y += 6;

    const sortedBib = [...currentData.biberons].sort((a, b) => a.heure.localeCompare(b.heure));
    if (!sortedBib.length) {
      doc.text('Aucun biberon saisi.', 14, y);
      y += 6;
    } else {
      sortedBib.forEach(bib => {
        if (y > 280) { doc.addPage(); y = 10; }
        doc.text(`- ${bib.heure} : ${bib.quantite} ml`, 14, y);
        y += 6;
      });
    }

    if (y > 280) { doc.addPage(); y = 10; }
    doc.text(`Total bu : ${totalMl} ml`, 10, y);
    y += 8;

    // Changes
    doc.text(`Changes (${currentData.changes.length})`, 10, y);
    y += 6;

    const sortedCh = [...currentData.changes].sort((a, b) => a.heure.localeCompare(b.heure));
    if (!sortedCh.length) {
      doc.text('Aucun change saisi.', 14, y);
      y += 6;
    } else {
      sortedCh.forEach(ch => {
        if (y > 280) { doc.addPage(); y = 10; }
        const types = [];
        if (ch.urine) types.push('urine');
        if (ch.selles) types.push('selles');
        doc.text(`- ${ch.heure} : ${types.join(' + ')}`, 14, y);
        y += 6;
      });
    }

    // Commentaires
    if (y > 280) { doc.addPage(); y = 10; }
    y += 4;
    doc.text(`Commentaires (${currentData.commentaires.length})`, 10, y);
    y += 6;

    const sortedCom = [...currentData.commentaires].sort((a, b) => a.heure.localeCompare(b.heure));
    if (!sortedCom.length) {
      doc.text('Aucun commentaire.', 14, y);
    } else {
      sortedCom.forEach(c => {
        if (y > 280) { doc.addPage(); y = 10; }
        // on coupe si c'est long (simple)
        const line = `- ${c.heure} : ${c.texte}`;
        const lines = doc.splitTextToSize(line, 180);
        doc.text(lines, 14, y);
        y += 6 * lines.length;
      });
    }

    doc.save(`suivi-bebe-${dateInput.value}.pdf`);
  }

  btnExportPdf.addEventListener('click', exportPdf);

  // ----- INIT -----
  (function init() {
    dateInput.value = getTodayStr();
    loadForCurrentDate();
    refreshDefaultTimes();
  })();


  // =====================================================
  //  STATS / CHART (bloc WP) - je le laisse, inchang√©
  //  ‚ö†Ô∏è Si tu es en HTML pur (pas WP), ajaxUrl/ajaxNonce
  //  n'existent pas et √ßa plantera.
  // =====================================================
  const selectDates = document.getElementById('bibitimeStatsDates');
  const info = document.getElementById('bibitimeStatsInfo');
  const canvas = document.getElementById('bibitimeStatsChart');

  let allStats = []; // [{date: 'YYYY-MM-DD', total_ml: 480}, ...]
  let chart = null;

  function loadStats() {
    // Protection si on n'est pas dans WP / si les variables n'existent pas
    if (typeof ajaxUrl === 'undefined' || typeof ajaxNonce === 'undefined') {
      info.textContent = 'Mode HTML : statistiques WP d√©sactiv√©es (ajaxUrl/ajaxNonce absents).';
      return;
    }
    if (typeof Chart === 'undefined') {
      info.textContent = 'Chart.js non charg√©.';
      return;
    }

    const formData = new FormData();
    formData.append('action', 'bibitime_get_stats');
    formData.append('security', ajaxNonce);

    fetch(ajaxUrl, {
      method: 'POST',
      credentials: 'same-origin',
      body: formData
    })
      .then(r => r.json())
      .then(json => {
        if (!json || !json.success || !json.data || !Array.isArray(json.data.stats)) {
          info.textContent = 'Aucune donn√©e trouv√©e pour le moment.';
          return;
        }

        allStats = json.data.stats;

        if (!allStats.length) {
          info.textContent = 'Aucune journ√©e enregistr√©e pour le moment.';
          return;
        }

        selectDates.innerHTML = '';
        allStats.forEach(stat => {
          const opt = document.createElement('option');
          opt.value = stat.date;
          opt.textContent = `${formatFrenchDate(stat.date)} ‚Äî ${stat.total_ml} ml`;
          selectDates.appendChild(opt);
        });

        // Par d√©faut : s√©lectionne tout (comme ton code)
        const nb = allStats.length;
        for (let i = allStats.length - nb; i < allStats.length; i++) {
          if (selectDates.options[i]) selectDates.options[i].selected = true;
        }

        updateChart();
      })
      .catch(() => {
        info.textContent = 'Erreur lors du chargement des statistiques.';
      });
  }

  function updateChart() {
    if (typeof Chart === 'undefined') return;

    const selectedValues = Array.from(selectDates.selectedOptions).map(o => o.value);
    const selectedStats = allStats
      .filter(s => selectedValues.includes(s.date))
      .sort((a, b) => a.date.localeCompare(b.date));

    if (!selectedStats.length) {
      info.textContent = 'S√©lectionne au moins une date pour afficher le graphique.';
      if (chart) { chart.destroy(); chart = null; }
      return;
    }

    info.textContent = selectedStats.length === 1
      ? 'Une seule date s√©lectionn√©e. Ajoute une deuxi√®me date pour voir la progression.'
      : `Comparaison sur ${selectedStats.length} jour(s).`;

    const labels = selectedStats.map(s => formatFrenchDate(s.date));
    const data = selectedStats.map(s => s.total_ml);

    const ctx = canvas.getContext('2d');
    if (chart) chart.destroy();

    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Total bu (ml)',
          data,
          tension: 0.3,
          fill: false
        }]
      },
      options: {
        responsive: true,
        aspectRatio: 1,
        plugins: {
          legend: { display: true },
          tooltip: { mode: 'index', intersect: false }
        },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'ml' } },
          x: { title: { display: true, text: 'Date' } }
        }
      }
    });
  }

  if (selectDates) selectDates.addEventListener('change', updateChart);
  document.addEventListener('DOMContentLoaded', loadStats);
</script>

</body>
</html>
